---
layout: docwithnav-trendz
assignees:
- vparomskiy
title: 缓存设置
description: Trendz 缓存设置
---

* TOC
{:toc}

Trendz 具有许多内置优化机制，用于改善报告生成时间。其中大多数开箱即用，无需任何配置。但其中一些机制应由管理员明确启用。

## Trendz 缓存级别

Trendz 支持 2 个缓存级别 - `查看报告` 缓存和 `指标长期缓存`。为了解释它们之间的区别，我们首先需要了解如何在 Trendz 中生成报告：

1. 用户创建视图配置，添加所需字段，然后按生成报告。
2. Trendz 根据视图配置生成查询执行计划。查询计划包含字段加载顺序和聚合策略。
3. 系统根据查询计划和配置的过滤器加载所需项目（设备/资产）。
4. 系统为每个项目加载字段值并对其进行聚合。
5. 在最后一步，生成视图报告并将其传递给 UI 以进行可视化。

大部分时间都花在项目加载和数据加载上（步骤 3 和步骤 4）。通过缓存这些步骤中的中间结果，我们可以提高系统性能。

`查看报告缓存` - 如果查询计划未更改，我们可以返回缓存的视图报告，而无需从 ThingsBoard 加载数据。
`指标长期缓存` - 在可以按固定间隔（如小时或日期）对数据进行分组的情况下，我们可以从缓存中加载已计算/聚合的字段值，而不是从 ThingsBoard 重新加载数据。

此缓存不连接到特定可视化，并且可以在多个视图中使用同一字段时重复使用。

#### 缓存间隔

Trendz 缓存包含特定时间间隔的聚合字段数据。用户可以定义用于数据缓存的时间间隔。

**完整日期** - 按天聚合遥测数据。我们将在缓存中为每一天保留 1 个值。
**完整小时** - 按小时聚合遥测数据。我们将在缓存中为每小时保留 1 个值。

选择哪个时间单位取决于要求，但在大多数情况下，按天聚合应该没问题。小时聚合唯一有用的选项 - 最终报告具有小时维度。例如，它可能是一个每周热图，因为它在 X 轴中具有小时字段。

#### 计划的缓存刷新

默认情况下，仅在按下生成报告按钮时初始化/更新缓存。当每天/每周生成大量报告并且用户首次加载报告时，这可能很关键。在这种情况下，缓存中还没有值，系统将直接从 ThingsBoard 加载数据，结果 - 用户将等待几分钟才能生成报告。

我们可以在后台触发定期缓存刷新。在这种情况下，当需要报告时，我们可以确保所有值已加载到缓存中，并且用户无需等待原始报告生成。

* 打开视图设置
* 导航到 **缓存** 部分
* 启用复选框 **自动刷新**
* 选择刷新间隔。例如，每天。
* 保存更改

在后台缓存刷新期间，Trendz 将向 ThingsBoard 发出请求。所有此类请求都应使用 JWT 令牌进行身份验证和签名。为了启用此类身份验证，管理员应在 Trendz 配置文件中定义登录/密码对 - `ADMIN_LOGIN` 和 `ADMIN_PASSWORD`。如果没有此步骤，计划的缓存刷新将不起作用，并且仅当用户从 UI 或 Rest API 请求报告时才会刷新缓存。

#### 清除缓存

如果需要，您可以清除长期缓存。如果在 ThingsBoard 中重新导入或更改历史数据，这可能很有用。

* 单击左下角的系统设置图标
* 打开设置
* 按 **清除缓存** 按钮在 **缓存** 部分

## 查看报告缓存

在某些情况下，我们可以重复使用已计算的视图报告，而不是从头开始计算。当在具有多个状态的仪表板上添加视图并且用户在它们之间主动导航时，此功能非常有用。每次打开状态时 - UI 将从服务器请求视图报告

在获取缓存报告之前，我们应该检查以下条件：

* 查询计划未更改。
* 时间范围未更改。
* 现有的视图报告未过期。

要启用此类型的缓存：

* 在系统设置中启用它 - `cache.report.enabled` - 默认情况下启用。
* 在视图设置 -> 缓存 -> 选中复选框 **缓存报告** - 默认情况下启用。