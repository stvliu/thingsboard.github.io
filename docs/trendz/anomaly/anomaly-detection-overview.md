---
layout: docwithnav-trendz
assignees:
- vparomskiy
title: 异常检测系统 — 概念和示例
description: 什么是异常检测系统？✔ 异常检测示例 ⚫ GridLinks ➤ 有关时序数据中异常检测的完整指南

scoreVsIndexExample:
    0:
        image: /images/trendz/anomaly/score_vs_index.png
        title: '启动期间的泵振动模式'
       
---

* TOC
{:toc}

## 简介
异常检测是任何资产监控系统的重要组成部分。基于阈值的简单条件监控是一个良好的起点，
但在需要分析多个遥测之间隐藏的相关性的场景中，它是无用的。在某些情况下，甚至无法
定义阈值，因为我们根本不知道它们。对于此类案例，Trendz Analytics 提供了基于
内置机器学习算法的自动异常检测工具。

您可以在此处找到有关如何使用 Trendz Analytics 创建异常检测模型的详细信息：
&nbsp;
<div id="video">  
    <div id="video_wrapper">
        <iframe src="https://www.youtube.com/embed/pbjXGDJ-SI0" frameborder="0" allowfullscreen></iframe>
    </div>
</div>

本文的目的是概述什么是异常检测、它是如何工作的以及如何实施它。

## 什么是异常
首先，我们需要定义什么是 [**异常**](https://en.wikipedia.org/wiki/Anomaly_detection){:target="_blank"} -
**它是一个设备或过程的行为与其他设备或过程不同的时间间隔**。

假设我们监控柴油发动机并收集转速、温度、振动等遥测数据。
我们可以分析发动机行为在不同条件下的变化，并可以比较不同发动机的行为。
我们知道当转速在 1000-1500 转/分之间时，温度应为 270-290°C。我们知道这一点，因为已经观察到这种
行为 1000 次。现在，如果我们看到在相同条件下，温度高于 350°C -
这是一个异常，因为它不是预期的行为。这是一个非常简单的示例，它解释了
在不同现实生活中的异常检测技术中使用的基本概念。
 
## 异常分数和分数指数
在系统中发现异常后，您需要对它们进行优先级排序并关注实际问题。异常评分作为
一种允许我们做到这一点的技术。

**异常分数** - 它是一个数字，表示当前行为与预期行为的差异程度。数字越大 - 我们看到的异常越大。在 Trendz 中，我们使用距离测量函数来计算异常分数。最简单的距离测量函数 - 欧几里得距离。但您还可以使用其他函数
如 - 切比雪夫、堪培拉、曼哈顿或动态时间规整 (DTW) 距离。

有时异常分数并不是异常优先级排序的理想候选者。
看看泵启动后振动的样子。

{% include images-gallery.html imageCollection="scoreVsIndexExample" showListImageTitles="true" preview="false" %}

* **正常行为** 预计新泵的振动模式。
* **异常_A** 具有更高的异常分数，因为我们在 5 秒内观察到一个大的振动峰值。
* **异常_B** 具有较低的异常分数，没有大的振动峰值

**异常_A** 与 **异常_B** 相比具有更高的异常分数，但 **异常_B** 异常的持续时间要长得多
而且我们很可能希望关注它，因为它与异常_A** 相比对泵的健康状况有更大的影响。
 
**异常分数指数** - 是一个结合异常分数和异常持续时间的指标。它被计算为预期
行为和实际行为之间的面积。此指标非常适合过滤误报异常并减少
在具有大量连接传感器的大型安装中发出警报。

## 技术背景

我们的目标是训练一个异常检测模型，将遥测标记为良好或异常。
这是一个 [**二元分类任务**](https://machinelearningmastery.com/types-of-classification-in-machine-learning/){:target="_blank"}。
有许多机器学习算法可以为我们完成这项工作并识别数据中的异常。我们可以将它们分为 2 组 - 监督和无监督算法。

#### 监督异常检测
监督算法需要标记的数据进行模型训练。这意味着我们应该说出哪些部分是好的，哪些部分包含异常。基于此知识，异常检测模型将训练以自动检测包含异常的部分。

最流行的监督分类算法是 - Knn、SVM、逻辑回归、决策树、RNN\LSTM。
这是一个很好的 [**概述这些算法及其工作原理**](https://builtin.com/data-science/supervised-machine-learning-classification/){:target="_blank"}。


尽管这些算法显示出良好的结果，但它们有一些重要的缺点：
1. 它们需要标记的数据集作为输入。当不存在标记数据并且手动标记将
花费大量时间和资源时，这可能是一个问题。
2. 如果数据集中还没有异常 - 我们无法训练模型来预测异常。
3. 监督模型不适用于在模型训练期间未观察到的新异常类型。例如，我们的模型
显示出检测与温度条件相关的异常的出色结果。但同一模型无法检测到机械
磨损，因为在训练数据集中没有观察到此类问题。

#### 无监督异常检测
无监督分类算法的主要优点是它们不需要标记的数据集进行模型
训练。因此，此类算法非常适合各种案例中的自动异常检测，例如
资产监控、过程故障检测、设备预测维护。

第二个优点 - 无监督模型在检测以前未观察到的异常模式方面表现出良好的结果。监督算法专注于发现已知异常，而无监督算法经过训练，可以告诉当前观察结果与预期结果的距离。   

最流行的无监督聚类和分类算法是 -
[**K-means、DBSCAN、高斯混合、凝聚层次聚类**](https://towardsdatascience.com/k-means-dbscan-gmm-agglomerative-clustering-mastering-the-popular-models-in-a-segmentation-c891a3818e29/){:target="_blank"}。


## 自动无监督异常检测的工作原理
我们将异常检测任务分解为更小的步骤：
1. 收集数据
2. 规范化数据
3. 将数据分成段
4. 提取每个段的特征
5. 训练异常检测模型将段标记为 **好** 或 **异常**
6. 计算异常段的异常分数
7. 验证结果
8. 应用模型实时检测异常

Trendz Analytics 具有内置工具，可以以最少的配置执行所有这些步骤。实际上
只需点击几下即可创建具有默认属性的异常检测模型。但为了了解它在后台的工作原理，我们将详细解释每个步骤应该做什么，并展示如何使用无监督机器学习
算法进行自动异常检测。


#### 自动无监督异常检测的工作原理
**步骤 1**：我们有来自传感器的各种数据段。每个段都是一个点。段的特征
是点坐标。

**步骤 2**：聚类算法迭代地将所有段分成不同的簇。几乎所有方法都使用
距离度量来查找相似段并将它们添加到同一个簇中。结果，我们收到几个
簇，每个簇包含彼此相似的多个段。

**步骤 3**：我们可以计算每个簇的质心 - 这个中心点描述了簇内有什么样的段并表示理想或良好点。此外，我们可以计算质心与任何
其他点之间的距离。此距离告诉我们该点与“理想”点的距离。

**步骤 4**：在分段后未包含在任何簇中或离簇质心太远的点
是异常点并表示异常。我们可以使用质心的距离作为异常分数。距离越大 - 异常越大。

距离测量函数在这里非常重要，因为它告诉了我们 2 个段的相似程度。最简单的距离测量函数 - 欧几里得距离。但您还可以使用其他函数
如 - 切比雪夫、
堪培拉、曼哈顿等。

动态时间规整 (DTW) 距离。
当我们想要比较时序的行为并且欧几里得距离没有显示出良好的结果时，我们建议尝试动态时间规整作为距离测量函数。动态时间规整
在比较失真间隔或具有相移的间隔时显示出良好的结果。此处有更多详细信息

## 数据分段 - 如何将遥测分成间隔
段是时间间隔的测量集合。它可以是 1 分钟/小时/天等。
间隔大小取决于我们解决的问题类型。一般建议 - 间隔应该足够大，以包含描述设备、资产或过程当前状态的数据。

例如，我们创建一个水泵的预测性维护模型并希望检测发动机异常。
泵可以在不同的负载下工作，但 5 分钟的间隔将描述它的工作方式和泵的当前状态 -  throughput、能耗、振动等。在这种情况下，我们将泵的数据分组为
具有 5 分钟间隔的段。
此外，我们分析水泵利用率以了解资源使用模式并希望检测异常
这将识别未经授权的使用、泄漏或盗窃。在这种情况下，段间隔将为 1 天
因为这样的间隔描述了泵的使用方式和时间。
类似的逻辑应用于其他业务领域 - 环境条件跟踪、电网、土壤和
作物监测、设备管理。

## 数据规范化
所有机器学习算法都需要规范化的输入数据进行训练。我们必须：
1. 将非数字值（如布尔值或文本）映射到数字值。
2. 从数据集中过滤噪声，例如极度异常的读数。
3. 填充数据中的空白。在现实生活中，由于不同的连接\软件问题，您总是会
在数据中留有空白。应删除空白以提高异常检测模型的准确性。
4. 将所有原始遥测值缩放至 [0;1]   范围。

Trendz 自动执行所有这些步骤。描述为什么这样做很重要以及如何做到这一点的优秀文章：
[https://medium.com/@urvashilluniya/why-data-normalization-is-necessary-for-machine-learning-models-681b65a05029](https://medium.com/@urvashilluniya/why-data-normalization-is-necessary-for-machine-learning-models-681b65a05029){:target="_blank"}.
[https://towardsdatascience.com/understand-data-normalization-in-machine-learning-8ff3062101f0](https://towardsdatascience.com/understand-data-normalization-in-machine-learning-8ff3062101f0){:target="_blank"}.


## 特征提取
最后一步是从每个段中提取特征，因为所有 ML 算法都使用特征向量
或简单的数字数组。每个段表示一个点，特征向量描述该点。
异常检测模型将训练以分配每个点（段）的正确分类。

有 2 种不同的方法来计算特征：
1. **基于行为的方法** 用于当段内的行为对我们很重要时。此类特征
描述遥测之间随时间的相关性以及遥测在段内如何变化的顺序。
2. 在 **基于特征的方法** 中，我们计算原始遥测数据的统计信息 - 最小值、最大值、变化、分布、斜率等。

如果您不知道选择哪种方法 - 尝试两种方法并比较结果。这真的很容易，因为在 Trendz 中
您只需从下拉列表中选择特征类型，然后单击“训练模型”，仅此而已。您不必
单独实现特征提取逻辑。

如果我们创建的模型仅使用 1 个遥测字段（例如温度）来检测异常，
那么它被称为单变量模型。但更受欢迎的是多变量模型 - 使用多个遥测。
在某些情况下，将设备的属性添加到模型中很有用。例如，固件版本或
设备位置可能是有助于检测异常行为的重要知识。



## 后续步骤

{% assign currentGuide = "CalculatedFields" %}{% include templates/trndz-guides-banner.md %}