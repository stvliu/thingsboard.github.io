* TOC
{:toc}

保留消息是 MQTT 的一项功能，允许在代理上存储特定主题的“最后已知良好”消息，并在客户端订阅匹配主题时将消息传递给客户端。

关于保留消息，有一些重要的注意事项：
* 代理上只能存储 **一条消息** **每个主题**。
* 在同一主题上发布的 **下一条消息** 将 **替换前一条消息**。
* 在同一主题上发布的 **有效负载为空的消息** 将 **完全清除** 该主题。
* 该主题的订阅者将 **仅接收最后一条消息**（如果可用）。

### 发布保留消息

在 MQTT 中，保留消息是指将 **保留标志** 设置为 _true_ 的常规发布消息。
让我们考虑一个使用 `mosquitto_pub` 发布保留消息的简单命令。

```shell
mosquitto_pub -d -h "YOUR_MQTT_BROKER_HOST" -p 1883 -D PUBLISH user-property hello world -q 1 -t demo/topic -V mqttv5 -m "Hello world" -r
```
{: .copy-code}

**注意，** 不要忘记将你的主机名替换为 `YOUR_MQTT_BROKER_HOST`。确保禁用身份验证。否则，请相应地调整本指南中的命令。

### 有效负载、用户属性

若要访问和查看 WEB UI 保留消息页面上特定主题的最后一条消息的有效负载和用户属性，请按照以下步骤操作：

1. 打开页面保留消息。
2. 若要查看保留消息的有效负载，请点击图标 `{}`。
3. 若要查看保留消息的用户属性，请点击图标 `[]`。请注意，如果按钮被禁用，则保留消息没有任何用户属性。

{% include images-gallery.html imageCollection="details-retained-messages" %}

### 删除保留消息

删除保留消息是一个简单的过程。若要删除以前的保留消息，可以向与要删除的保留消息关联的特定主题发送一个 `零字节有效负载` 的新保留消息。随后，该主题的任何新订阅者将不再收到以前保留的消息。

若要删除主题 `demo/topic` 的保留消息，可以使用以下命令，指定带有零字节有效负载的 `-n` 标志：

```shell
mosquitto_pub -d -h "YOUR_MQTT_BROKER_HOST" -p 1883 -q 1 -t demo/topic -n -r
```
{: .copy-code}

若要使用 TBMQ 的 WEB UI 删除保留消息，你可以根据要删除的消息数量选择两个选项：
1. **删除单个保留消息。** 点击图标“删除保留消息”并确认操作。
2. **删除多个保留消息：**
  * 选择要删除的消息。
  * 点击右上角的“删除保留消息”按钮，并在出现提示时确认操作。

{% include images-gallery.html imageCollection="delete-retained-messages" %}

### 清除空的保留消息节点

代理中的保留消息使用 [Trie](https://en.wikipedia.org/wiki/Trie) 数据结构存储在内存中，Trie 以其高效的搜索能力而闻名。
Trie（也称为前缀树）是一种基于树的数据结构，它允许根据键或字符序列快速检索信息。

Trie 以分层的方式组织主题名称，其中每个节点表示主题名称中的一个主题级别。
通过使用 Trie 数据结构，代理可以根据订阅客户端提供的主题过滤器快速定位和检索保留消息。这确保客户端可以收到他们感兴趣的保留消息，而不会出现明显的延迟，从而提高代理的性能和响应能力。

当删除保留消息时，代理会从其内存中删除消息有效负载并将节点标记为空。
随着时间的推移，如果删除了许多保留消息，代理的内存中可能会留下许多空节点。
这些空节点会导致效率低下并浪费内存资源。

清除空的保留消息节点可以释放内存资源并提高代理的性能，因为它可以在搜索更少的空节点时更快地处理 MQTT 消息。

若要清除空的保留消息节点，请点击右上角的“清除空的保留消息节点”按钮并确认操作。

{% include images-gallery.html imageCollection="clear-empty-retained-messages" %}

此外，代理配置为由调度程序清除空的保留消息节点。这由以下环境变量控制：
`MQTT_RETAIN_MSG_TRIE_CLEAR_NODES_CRON` 和 `MQTT_RETAIN_MSG_TRIE_CLEAR_NODES_ZONE`。